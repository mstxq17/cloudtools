<!-- 
    程序名称: 临时文件展示
    程序功能: 临时文件展示
    设计人员: xq17
    设计时间: 2020-09-18 00:26:55
-->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <!-- 元信息 -->
    <meta charset="UTF-8">
    <meta name="Generator" content="Sublime_Text@">
    <meta name="Author" content="xq17">
    <meta name="KeyWords" content="study">
    <meta name="Description" content="frontend study">
    <!-- 设置http头部 -->
    <meta name="http-equiv" content="text/html;" />
    <meta name="viewport" content="width=device-width ,init-scale=1" />
    <link rel="shortcut icon" href="favicon.ico">
    <!-- 标题 -->
    <title>cloudTools-临时文件站</title>
    <!-- script -->
    <script src="static/javascript/jquery-3.4.1.js"></script>
    <script src="static/layer/layer.js"></script>
    <script src="static/javascript/axios.min.js"></script>
    <script src="static/javascript/bootstrap.min.js"></script>
    <script src="static/javascript/clipboard.min.js"></script>
    <!-- link -->
    <link rel="stylesheet" type="text/css" href="static/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/css/main.css">
    <link rel="stylesheet" type="text/css" href="static/css/upload-file.css">
    <!-- css style -->
    <style type="text/css">
    </style>
</head>

<body>
	<div class="modal fade" id="shortURLModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- 模态框头部 -->
                <div class="modal-header">
                    <h5 class="modal-title">下载方式</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <!-- 模态框主体 -->
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="short-url" class="control-label">生成短链接:</label>
                            <a id="shortA" href="" target="_blank"></a>
                        </div>
                        <div class="form-group">
                            <label for="download-way" class="control-label">下载方式:</label>
                            <div>
                                Window:
                                <div id="codeBack">
                                    <p class="form-controll">
                                        <code>1.powershell (new-object System.Net.WebClient).DownloadFile("url","c:\x.png");
                                            <br />
                                            <br />
                                        </code>
                                        <code>
                                            2.certutil -urlcache -split -f "url"
                                            <br />
                                        </code>
                                        <code>
                                            3.curl -o x.zip "url"
                                            <br />
                                        </code>
                                        <code>
                                            4.bitsadmin /transfer n "url" c:\x.txt
                                        </code>
                                    </p>
                                </div>
                                Linux:
                                <div id="codeBack">
                                    <p class="form-controll">
                                        <code>1.wget -o x.png "url"</code>
                                        <br />
                                        <code>2.curl -o x.zip "url"</code>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- 模态框底部 -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="card card-temp is-show">
            <div class="card-body">
                <h2 class="card-title">上传结果</h2>
                <label>
                    <img id="code" src="" alt="">
                </label>
                <textarea id="url" class="form-control"></textarea>
                <br />
                <p>上传成功，扫码/访问<a id="urlA">链接</a> 即可下载！
                </p>
                <p class="badge-wrap">
                    <a href="/cloudtools" title="返回登录注册页面" class="badge btn-success">
                        <i class="fa fa-backward" aria-hidden="true">
                        </i>
                    </a>
                </p>
                <div id="shortURL">
                    <a href="#shortURLModal" data-toggle="modal">高级模式</a>
                    <i class="fa fa-chain" aria-hidden="true"></i>
                </div>
                <!-- 短连接展示模态框 -->
            </div>
        </div>
    </div>
</body>

<script>
$(function(){
	$.get("file/api/showTempFile",{},(result,status)=>{
		var data;
		if(status=="success"){
			data=result.data;
		}else{
			data=result.data;
			layer.msg("服务器异常!", {icon:2, time:3000}, function(){
				location = "/cloudtools";
			});
			return;
		}
		if(result.code == 200){
			if(data){
				$("#code").attr("src",data.imgPath);
				$("#url").val(data.url);
				$("#urlA").attr("href", data.url);
				return;
			}
		}else if(result.code == 301){
			layer.confirm(result.msg, {
				  btn: ['确定'] //按钮
				}, function(){
				  layer.msg('正在跳转回上一个页面', {icon: 1});
				  if(document.referer){
					  location = document.referer;  
				  }else{
					  location="/cloudtools";
				  }
				});
			return;
		}else{
			layer.confirm(result.msg, {
				  btn: ['确定'] //按钮
				}, function(){
				  layer.msg('正在跳转回上一个页面', {icon: 1});
				  if(document.referer){
					  location = document.referer;  
				  }else{
					  location="/cloudtools";
				  }
				});
			return;
		}
	} ,"json");
});

$('#shortURLModal').on('show.bs.modal', function(event) {
    let token;
    let shortURL;
    let originURL;
    modal = $(this);
    var index = layer.load(1);
    // 先请求获取到114mx的token
    layer.msg("正在生成短链接...")
    axios.get("file/api/getToken",{})
    .then(function(response){
        token = response.data.data.token;
        originURL = $("#url").val().trim();
        const params = new URLSearchParams();
        params.append('LongUrl', originURL);
        params.append('token', token);
        axios.post('http://114.mx/home/index', params)
        .then(function (response) {
        	rsp = response;
        	if(rsp.error)
        	{
        		layer.msg(rsp.data.msg, {time:1000, icon:5});
        		return;
        	}
        	shortURL = rsp.data.short;
            modal.find('.modal-body #shortA').text(shortURL);
            modal.find('.modal-body #shortA').attr("href", shortURL);
            layer.close(index);
            layer.msg("成功生成短链接!",{"icon":1, time:1000});
          })
          .catch(function (error) {
        	  layer.close(index);
        	  layer.msg("生成失败,服务器错误！", {time:1000, icon:5});
          });
    })
    .catch(function (error){
  	  	layer.msg("服务器错误！", {time:1000, "icon":5});
    });
})
</script>
</html>